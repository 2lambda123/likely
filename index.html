<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Likely</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Literate Kernel Library">
  <meta name="author" content="Josh Klontz">

  <link href="bootstrap/css/bootstrap.css" rel="stylesheet">
  <style>
    body {
      padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
    }
  </style>
  <link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet">

  <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
  <!--[if lt IE 9]>
    <script src="../assets/js/html5shiv.js"></script>
  <![endif]-->

  <script type="text/javascript"
    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>

  <link href="google-code-prettify/prettify.css" type="text/css" rel="stylesheet"/>
  <script type="text/javascript" src="google-code-prettify/prettify.js"></script>
</head>

<body onload="prettyPrint()">
  <div class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container"> <div class="row"> <div class="span12">
        <a class="brand" href="#">Likely</a>
        <ul class="nav">
          <li><a href="https://github.com/biometrics/likely">Source</a></li>
          <li><a href="https://github.com/jklontz">Author</a></li>
        </ul>
        <ul class="nav pull-right">
          <li><a class="pull-right" href="LICENSE.txt">Licensed under Apache 2.0 &copy; 2013 Joshua C. Klontz</a></li>
        </ul>
      </div> </div> </div>
    </div>
  </div>

  <div class="container"> <div class="row"> <div class="span12">
    <h1 id="literate_kernel_library">Literate Kernel Library</h1>
    <p class="lead">Beautiful image processing functions for heterogenous architectures.</p>
    <h2>Table of Contents</h2>
    <ul class="nav nav-pills nav-stacked">
      <li><a href="#introduction">Introduction</a></li>
      <li><a href="#installation">Installation</a></li>
      <li><a href="#api_overview">API Overview</a></li>
    </ul>
    <h2 id="introduction">Introduction</h2>
    <p>Welcome to the documentation <i>and source code</i> for <i>Likely</i> the literate kernel library!
       Simply stated, the goals of Likely are to provide image processing and machine learning functions, or <i>kernels</i>, that are:
      <ul>
        <li>executable everywhere.</li>
        <li>perfectly optimized.</li>
        <li>uncompromisingly elegant.</li>
      </ul>
    </p>
    <h3 id="executable_everywhere">Executable Everywhere</h3>
    <p>Likely is written in plain old <i>ISO C++ '98</i> and depends only on <i>LLVM</i> which means it runs <a href="http://llvm.org/docs/GettingStarted.html#hardware">everywhere LLVM does</a>.
      Kernels execute natively on single CPU threads via the LLVM <i>Just-In-Time</i> (JIT) compiler, multi-core CPUs with <i>OpenMP</i>, and <i>OpenCL</i> compatible GPUs and coprocessors.
    </p>
    <h3 id="perfectly_optimized">Perfectly Optimized</h3>
    <p>Likely relies on the powerful and well established LLVM optimization passes to make kernel execution as fast as possible.
      Since compilation is held off until runtime, kernels are optimized to take advantage of all instruction set extensions available on the host processor.
      In reality, compilation is delayed until a function is called for the first time, enabling optimization opportunities that are impossible in conventional image processing libraries.
      The entire premise of Likely is hinged on the observation that for image processing applications
      <blockquote>
        <p>while kernels must be written generically to handle any matrix type, at runtime they tend to be executed repeatedly on the same type.</p>
      </blockquote>
      The repeated execution of a kernel with the same matrix type means that branching to handle different data types is unnecessary, entire loops and code blocks can be eliminated, and many values that would be runtime parameters instead become compile time constants.
      For this reason, it's not uncommon for Likely kernels to be <i>faster</i> than equally generic <tt>C</tt> code.
    </p>
    <p id="hash_introduction">In Likely, a matrix's type is referred to as its <i><a href="#the_matrix_hash">hash</a></i>, encompassing its data type (<tt>integer</tt> or <tt>floating point</tt>), depth (<tt>8</tt>, <tt>16</tt>, <tt>32</tt>, or <tt>64</tt> bits), computation location (<tt>single-threaded CPU</tt>, <tt>OpenMP CPU</tt>, or <tt>OpenCL coprocessor</tt>), and its <tt>single-dimension</tt> axes.
      Likely functions check the input's hash against the currently compiled kernel's hash and recompile on a mismatch.
      In this way,
      <blockquote>
        <p>all the logic needed to handle different matrix types is reduced to a single 16-bit integer comparison which branch prediction can optimize out.</p>
      </blockquote>
    </p>
    <h3 id="uncompromisingly_elegant">Uncompromisingly Elegant</h3>
    <p>Likely is inspired by Donald Knuth's <i>literate programming</i>.
      It is a <i>literate</i> kernel library because
      <blockquote>
        <p>all the kernels documented on this webpage are also the source code for the library.</p>
      </blockquote>
      In fact, this webpage is compiled into the Likely library and parsed at runtime to extract kernel definitions.
      You can access this content for yourself with <code class="prettyprint lang-c">const char *this_webpage = likely_index_html();</code>.
    </p>
    <p>Kernels are written in <i>MathML</i> allowing them to be rendered cleanly here and parsed easily by the backend.</p>
    <h2 id="installation">Installation</h2>
    <p>The following sections discuss how to build and incorporate Likely into your own project.</p>
    <h3 id="build_instructions">Build Instructions</h3>
    <p>Likely uses the <i>CMake</i> (>= 2.8.9) build system and will automatically download and compile its LLVM dependency.</p>
    <pre>$ git clone https://github.com/biometrics/likely.git<br>$ cd likely<br>$ mkdir build<br>$ cd build<br>$ cmake ..<br>$ make -j4</pre>
    <p>Unit tests are an optional build flag whereby kernels are compared against equivalent <i>OpenCV</i> functions for correctness and speed.
      The build system will automatically download and compile OpenCV.
    </p>
    <pre>$ cmake -D BUILD_TESTING=ON ..<br>$ make -j4</pre>
    <p>Installation and packaging work as expected.</p>
    <pre>$ make install<br>$ cpack -G TGZ</pre>
    <h3 id="usage">Usage</h3>
    <p>C/C++ projects should <code class="prettyprint lang-c">#include &lt;likely.h&gt;</code> and link against the <code>likely</code> shared library.
      <tt>FindLikely.cmake</tt> is provided as a convenience to CMake developers.
    </p>
    <h2 id="api_overview">API Overview</h2>
    <p>Likely is a C API that provides an optional C++ wrapper.
      Definitions in the C API are prefixed with <tt>likely_</tt> and use a <tt>lowercase_underscore</tt> naming convention.
      Definitions in the C++ wrapper live in <tt>namespace likely</tt> and use a <tt>camelCase</tt> naming convention.
      Consider taking a moment to skim the <a href="likely.h">header file</a>.
    </p>
    <h3 id="the_matrix_struct">The Matrix Struct</h3>
    <p>The <tt>likely_matrix</tt> is only struct in the API and serves as the input and output for all kernel invocations.
      The <tt>likely_matrix</tt>, hereafter referred to as the <i>matrix</i>, has the following fields:
    </p>
    <pre class="prettyprint lang-c">uint8_t *data; // Pointer to the buffer of elements<br>uint32_t channels, columns, rows, frames; // Dimensions<br>uint16_t hash; // Data type</pre>
    <p>In contrast to conventional image processing libraries which tend to feature 3-dimensional matrices (<i>channels</i>, <i>columns</i>, <i>rows</i>), Likely includes a fourth dimension, <i>frames</i>, in order to facilitate processing videos or collections of images.
    <h4 id="element_access">Element Access</h4>
    <p>Element layout in the <i>data</i> buffer in terms of decreasing spatial locality is <i>channel</i>, <i>column</i>, <i>row</i>, <i>frame</i>.
      Thus an element at channel <i>c</i>, column <i>x</i>, row <i>y</i>, and frame <i>t</i>, or (c, x, y, t), can be accessed like:
    </p>
    <pre class="prettyprint lang-c">likely_matrix *m = foo();<br>int columnStep = m->channels;<br>int rowStep = m->channels * columnStep;<br>int frameStep = m->rows * rowStep;<br>assert(likely_type(m) == likely_matrix::f64);<br>double element = ((double*)m->data)[t*frameStep + y*rowStep + x*columnStep + c];</pre>
    <p>Convenience functions <code class="prettyprint lang-c">double likely_element(...)</code> and <code class="prettyprint lang-c">void likely_set_element(...)</code> are provided for individual element access.</p>
    <h4 id="the_matrix_hash">The Matrix Hash</h4>
    <p>As suggested in the <a href="#hash_introduction">introduction</a>, the matrix hash plays a critical role in determining how to process the matrix.
      It informs the function what data type the matrix is and where to process it.
      It also encodes which, if any, of channels, columns, rows, and frames of the matrix are length 1.
      This knowledge is used at kernel compile time to simplify element access algebra and remove unneccesary loops.
    </p>
  </div> </div> </div>
</body>

</html>
